(function(a){a.widget("ui.selectmenu",{options:{appendTo:"body",typeAhead:1000,style:"dropdown",positionOptions:{my:"left top",at:"left bottom",offset:null},width:null,menuWidth:null,handleWidth:26,maxHeight:null,icons:null,format:null,escapeHtml:false,bgImage:function(){}},_create:function(){var e=this,c=this.options;var d=(this.element.attr("id")||"ui-selectmenu-"+Math.random().toString(16).slice(2,10)).replace(/(:|\.)/g,"");this.ids=[d,d+"-button",d+"-menu"];this._safemouseup=true;this.isOpen=false;var b=this.element.hasClass("input-validation-error");this.newelement=a("<a />",{"class":this.widgetBaseClass+" ui-widget ui-state-default ui-corner-all "+(b?"input-validation-error":""),id:this.ids[1],role:"button",href:"#nogo",tabindex:this.element.attr("disabled")?1:0,"aria-haspopup":true,"aria-owns":this.ids[2]});this.newelementWrap=a("<span />").append(this.newelement).insertAfter(this.element);var f=this.element.attr("tabindex");if(f){this.newelement.attr("tabindex",f)}this.newelement.data("selectelement",this.element);this.selectmenuIcon=a('<span class="'+this.widgetBaseClass+'-icon ui-icon"></span>').prependTo(this.newelement);this.newelement.prepend('<span class="'+e.widgetBaseClass+'-status" />');this.element.bind({"click.selectmenu":function(g){e.newelement.focus();g.preventDefault()}});this.newelement.bind("mousedown.selectmenu",function(g){e._toggle(g,true);if(c.style=="popup"){e._safemouseup=false;setTimeout(function(){e._safemouseup=true},300)}return false}).bind("click.selectmenu",function(){return false}).bind("keydown.selectmenu",function(g){var h=false;switch(g.keyCode){case a.ui.keyCode.ENTER:h=true;break;case a.ui.keyCode.SPACE:e._toggle(g);break;case a.ui.keyCode.UP:if(g.altKey){e.open(g)}else{e._moveSelection(-1)}break;case a.ui.keyCode.DOWN:if(g.altKey){e.open(g)}else{e._moveSelection(1)}break;case a.ui.keyCode.LEFT:e._moveSelection(-1);break;case a.ui.keyCode.RIGHT:e._moveSelection(1);break;case a.ui.keyCode.TAB:h=true;break;case a.ui.keyCode.PAGE_UP:case a.ui.keyCode.HOME:e.index(0);break;case a.ui.keyCode.PAGE_DOWN:case a.ui.keyCode.END:e.index(e._optionLis.length);break;default:h=true}return h}).bind("keypress.selectmenu",function(g){if(g.which>0){e._typeAhead(g.which,"mouseup")}return true}).bind("mouseover.selectmenu",function(){if(!c.disabled){a(this).addClass("ui-state-hover")}}).bind("mouseout.selectmenu",function(){if(!c.disabled){a(this).removeClass("ui-state-hover")}}).bind("focus.selectmenu",function(){if(!c.disabled){a(this).addClass("ui-state-focus")}}).bind("blur.selectmenu",function(){if(!c.disabled){a(this).removeClass("ui-state-focus")}});a(document).bind("mousedown.selectmenu-"+this.ids[0],function(g){if(e.isOpen){e.close(g)}});this.element.bind("click.selectmenu",function(){e._refreshValue()}).bind("focus.selectmenu",function(){if(e.newelement){e.newelement[0].focus()}});if(!c.width){c.width=this.element.outerWidth()+40}this.newelement.width(c.width);this.element.hide();this.list=a("<ul />",{"class":"ui-widget ui-widget-content","aria-hidden":true,role:"listbox","aria-labelledby":this.ids[1],id:this.ids[2]});this.listWrap=a("<div />",{"class":e.widgetBaseClass+"-menu"}).append(this.list).appendTo(c.appendTo);this.list.bind("keydown.selectmenu",function(g){var h=false;switch(g.keyCode){case a.ui.keyCode.UP:if(g.altKey){e.close(g,true)}else{e._moveFocus(-1)}break;case a.ui.keyCode.DOWN:if(g.altKey){e.close(g,true)}else{e._moveFocus(1)}break;case a.ui.keyCode.LEFT:e._moveFocus(-1);break;case a.ui.keyCode.RIGHT:e._moveFocus(1);break;case a.ui.keyCode.HOME:e._moveFocus(":first");break;case a.ui.keyCode.PAGE_UP:e._scrollPage("up");break;case a.ui.keyCode.PAGE_DOWN:e._scrollPage("down");break;case a.ui.keyCode.END:e._moveFocus(":last");break;case a.ui.keyCode.ENTER:case a.ui.keyCode.SPACE:e.close(g,true);a(g.target).parents("li:eq(0)").trigger("mouseup");break;case a.ui.keyCode.TAB:h=true;e.close(g,true);a(g.target).parents("li:eq(0)").trigger("mouseup");break;case a.ui.keyCode.ESCAPE:e.close(g,true);break;default:h=true}return h}).bind("keypress.selectmenu",function(g){if(g.which>0){e._typeAhead(g.which,"focus")}return true}).bind("mousedown.selectmenu mouseup.selectmenu",function(){return false});a(window).bind("resize.selectmenu-"+this.ids[0],a.proxy(e.close,this))},_init:function(){var n=this,k=this.options;var m=[];this.element.find("option").each(function(){var i=a(this);m.push({value:i.attr("value"),text:n._formatText(i.text()),selected:i.attr("selected"),disabled:i.attr("disabled"),classes:i.attr("class"),typeahead:i.attr("typeahead"),parentOptGroup:i.parent("optgroup"),bgImage:k.bgImage.call(i)})});var b=(n.options.style=="popup")?" ui-state-active":"";this.list.html("");if(m.length){for(var c=0;c<m.length;c++){var s={role:"presentation"};if(m[c].disabled){s["class"]=this.namespace+"-state-disabled"}var q={html:m[c].text||"&nbsp;",href:"#nogo",tabindex:-1,role:"option","aria-selected":false};if(m[c].disabled){q["aria-disabled"]=m[c].disabled}if(m[c].typeahead){q.typeahead=m[c].typeahead}var p=a("<a/>",q);var r=a("<li/>",s).append(p).data("index",c).addClass(m[c].classes).data("optionClasses",m[c].classes||"").bind("mouseup.selectmenu",function(j){if(n._safemouseup&&!n._disabled(j.currentTarget)&&!n._disabled(a(j.currentTarget).parents("ul>li."+n.widgetBaseClass+"-group "))){var i=a(this).data("index")!=n._selectedIndex();n.index(a(this).data("index"));n.select(j);if(i){n.change(j)}n.close(j,true)}return false}).bind("click.selectmenu",function(){return false}).bind("mouseover.selectmenu focus.selectmenu",function(i){if(!a(i.currentTarget).hasClass(n.namespace+"-state-disabled")&&!a(i.currentTarget).parent("ul").parent("li").hasClass(n.namespace+"-state-disabled")){n._selectedOptionLi().addClass(b);n._focusedOptionLi().removeClass(n.widgetBaseClass+"-item-focus ui-state-hover");a(this).removeClass("ui-state-active").addClass(n.widgetBaseClass+"-item-focus ui-state-hover")}}).bind("mouseout.selectmenu blur.selectmenu",function(){if(a(this).is(n._selectedOptionLi().selector)){a(this).addClass(b)}a(this).removeClass(n.widgetBaseClass+"-item-focus ui-state-hover")});if(m[c].parentOptGroup.length){var l=n.widgetBaseClass+"-group-"+this.element.find("optgroup").index(m[c].parentOptGroup);if(this.list.find("li."+l).length){this.list.find("li."+l+":last ul").append(r)}else{a(' <li role="presentation" class="'+n.widgetBaseClass+"-group "+l+(m[c].parentOptGroup.attr("disabled")?" "+this.namespace+'-state-disabled" aria-disabled="true"':'"')+'><span class="'+n.widgetBaseClass+'-group-label">'+m[c].parentOptGroup.attr("label")+"</span><ul></ul></li> ").appendTo(this.list).find("ul").append(r)}}else{r.appendTo(this.list)}if(k.icons){for(var f in k.icons){if(r.is(k.icons[f].find)){r.data("optionClasses",m[c].classes+" "+n.widgetBaseClass+"-hasIcon").addClass(n.widgetBaseClass+"-hasIcon");var d=k.icons[f].icon||"";r.find("a:eq(0)").prepend('<span class="'+n.widgetBaseClass+"-item-icon ui-icon "+d+'"></span>');if(m[c].bgImage){r.find("span").css("background-image",m[c].bgImage)}}}}}}else{a('<li role="presentation"><a href="#nogo" tabindex="-1" role="option"></a></li>').appendTo(this.list)}var e=(k.style=="dropdown");this.newelement.toggleClass(n.widgetBaseClass+"-dropdown",e).toggleClass(n.widgetBaseClass+"-popup",!e);this.list.toggleClass(n.widgetBaseClass+"-menu-dropdown ui-corner-bottom",e).toggleClass(n.widgetBaseClass+"-menu-popup ui-corner-all",!e).find("li:first").toggleClass("ui-corner-top",!e).end().find("li:last").addClass("ui-corner-bottom");this.selectmenuIcon.toggleClass("ui-icon-triangle-1-s",e).toggleClass("ui-icon-triangle-2-n-s",!e);if(k.style=="dropdown"){this.list.width(k.menuWidth?k.menuWidth:k.width)}else{this.list.width(k.menuWidth?k.menuWidth:k.width-k.handleWidth)}this.list.css("height","auto");var g=this.listWrap.height();var t=a(window).height();var h=k.maxHeight?Math.min(k.maxHeight,t):t/3;if(g>h){this.list.height(h)}this._optionLis=this.list.find("li:not(."+n.widgetBaseClass+"-group)");if(this.element.attr("disabled")){this.disable()}else{this.enable()}this.index(this._selectedIndex());this._selectedOptionLi().addClass(this.widgetBaseClass+"-item-focus");clearTimeout(this.refreshTimeout);this.refreshTimeout=window.setTimeout(function(){n._refreshPosition()},200)},destroy:function(){this.element.removeData(this.widgetName).removeClass(this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").removeAttr("aria-disabled").unbind(".selectmenu");a(window).unbind(".selectmenu-"+this.ids[0]);a(document).unbind(".selectmenu-"+this.ids[0]);this.newelementWrap.remove();this.listWrap.remove();this.element.unbind(".selectmenu").show();a.Widget.prototype.destroy.apply(this,arguments)},_typeAhead:function(d,e){var k=this,b=String.fromCharCode(d).toLowerCase(),g=null,h=null;if(k._typeAhead_timer){window.clearTimeout(k._typeAhead_timer);k._typeAhead_timer=undefined}k._typeAhead_chars=(k._typeAhead_chars===undefined?"":k._typeAhead_chars).concat(b);if(k._typeAhead_chars.length<2||(k._typeAhead_chars.substr(-2,1)===b&&k._typeAhead_cycling)){k._typeAhead_cycling=true;g=b}else{k._typeAhead_cycling=false;g=k._typeAhead_chars}var j=(e!=="focus"?this._selectedOptionLi().data("index"):this._focusedOptionLi().data("index"))||0;for(var f=0;f<this._optionLis.length;f++){var l=this._optionLis.eq(f).text().substr(0,g.length).toLowerCase();if(l===g){if(k._typeAhead_cycling){if(h===null){h=f}if(f>j){h=f;break}}else{h=f}}}if(h!==null){this._optionLis.eq(h).find("a").trigger(e)}k._typeAhead_timer=window.setTimeout(function(){k._typeAhead_timer=undefined;k._typeAhead_chars=undefined;k._typeAhead_cycling=undefined},k.options.typeAhead)},_uiHash:function(){var b=this.index();return{index:b,option:a("option",this.element).get(b),value:this.element[0].value}},open:function(b){var f=this,d=this.options;if(f.newelement.attr("aria-disabled")!="true"){f._closeOthers(b);f.newelement.addClass("ui-state-active");f.list.attr("aria-hidden",false);f.listWrap.addClass(f.widgetBaseClass+"-open");var e=this._selectedOptionLi();if(d.style=="dropdown"){f.newelement.removeClass("ui-corner-all").addClass("ui-corner-top")}else{this.list.css("left",-5000).scrollTop(this.list.scrollTop()+e.position().top-this.list.outerHeight()/2+e.outerHeight()/2).css("left","auto")}f._refreshPosition();var c=e.find("a");if(c.length){c[0].focus()}f.isOpen=true;f._trigger("open",b,f._uiHash())}},close:function(b,c){if(this.newelement.is(".ui-state-active")){this.newelement.removeClass("ui-state-active");this.listWrap.removeClass(this.widgetBaseClass+"-open");this.list.attr("aria-hidden",true);if(this.options.style=="dropdown"){this.newelement.removeClass("ui-corner-top").addClass("ui-corner-all")}if(c){this.newelement.focus()}this.isOpen=false;this._trigger("close",b,this._uiHash())}},change:function(b){this.element.trigger("change");this._trigger("change",b,this._uiHash())},select:function(b){if(this._disabled(b.currentTarget)){return false}this._trigger("select",b,this._uiHash())},widget:function(){return this.listWrap.add(this.newelementWrap)},_closeOthers:function(b){a("."+this.widgetBaseClass+".ui-state-active").not(this.newelement).each(function(){a(this).data("selectelement").selectmenu("close",b)});a("."+this.widgetBaseClass+".ui-state-hover").trigger("mouseout")},_toggle:function(b,c){if(this.isOpen){this.close(b,c)}else{this.open(b)}},_formatText:function(b){if(this.options.format){b=this.options.format(b)}else{if(this.options.escapeHtml){b=a("<div />").text(b).html()}}return b},_selectedIndex:function(){return this.element[0].selectedIndex},_selectedOptionLi:function(){return this._optionLis.eq(this._selectedIndex())},_focusedOptionLi:function(){return this.list.find("."+this.widgetBaseClass+"-item-focus")},_moveSelection:function(b,e){if(!this.options.disabled){var c=parseInt(this._selectedOptionLi().data("index")||0,10);var d=c+b;if(d<0){d=0}if(d>this._optionLis.size()-1){d=this._optionLis.size()-1}if(d===e){return false}if(this._optionLis.eq(d).hasClass(this.namespace+"-state-disabled")){(b>0)?++b:--b;this._moveSelection(b,d)}else{this._optionLis.eq(d).trigger("mouseover").trigger("mouseup")}}},_moveFocus:function(c,f){if(!isNaN(c)){var d=parseInt(this._focusedOptionLi().data("index")||0,10);var e=d+c}else{var e=parseInt(this._optionLis.filter(c).data("index"),10)}if(e<0){e=0}if(e>this._optionLis.size()-1){e=this._optionLis.size()-1}if(e===f){return false}var b=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1000);this._focusedOptionLi().find("a:eq(0)").attr("id","");if(this._optionLis.eq(e).hasClass(this.namespace+"-state-disabled")){(c>0)?++c:--c;this._moveFocus(c,e)}else{this._optionLis.eq(e).find("a:eq(0)").attr("id",b).focus()}this.list.attr("aria-activedescendant",b)},_scrollPage:function(b){var c=Math.floor(this.list.outerHeight()/this._optionLis.first().outerHeight());c=(b=="up"?-c:c);this._moveFocus(c)},_setOption:function(b,c){this.options[b]=c;if(b=="disabled"){if(c){this.close()}this.element.add(this.newelement).add(this.list)[c?"addClass":"removeClass"](this.widgetBaseClass+"-disabled "+this.namespace+"-state-disabled").attr("aria-disabled",c)}},disable:function(b,c){if(typeof(b)=="undefined"){this._setOption("disabled",true)}else{if(c=="optgroup"){this._disableOptgroup(b)}else{this._disableOption(b)}}},enable:function(b,c){if(typeof(b)=="undefined"){this._setOption("disabled",false)}else{if(c=="optgroup"){this._enableOptgroup(b)}else{this._enableOption(b)}}},_disabled:function(b){return a(b).hasClass(this.namespace+"-state-disabled")},_disableOption:function(b){var c=this._optionLis.eq(b);if(c){c.addClass(this.namespace+"-state-disabled").find("a").attr("aria-disabled",true);this.element.find("option").eq(b).attr("disabled","disabled")}},_enableOption:function(b){var c=this._optionLis.eq(b);if(c){c.removeClass(this.namespace+"-state-disabled").find("a").attr("aria-disabled",false);this.element.find("option").eq(b).removeAttr("disabled")}},_disableOptgroup:function(b){var c=this.list.find("li."+this.widgetBaseClass+"-group-"+b);if(c){c.addClass(this.namespace+"-state-disabled").attr("aria-disabled",true);this.element.find("optgroup").eq(b).attr("disabled","disabled")}},_enableOptgroup:function(b){var c=this.list.find("li."+this.widgetBaseClass+"-group-"+b);if(c){c.removeClass(this.namespace+"-state-disabled").attr("aria-disabled",false);this.element.find("optgroup").eq(b).removeAttr("disabled")}},index:function(b){if(arguments.length){if(!this._disabled(a(this._optionLis[b]))){this.element[0].selectedIndex=b;this._refreshValue()}else{return false}}else{return this._selectedIndex()}},value:function(b){if(arguments.length){this.element[0].value=b;this._refreshValue()}else{return this.element[0].value}},text:function(){return this._selectedOptionLi()[0].innerText},_refreshValue:function(){var b=(this.options.style=="popup")?" ui-state-active":"";var c=this.widgetBaseClass+"-item-"+Math.round(Math.random()*1000);this.list.find("."+this.widgetBaseClass+"-item-selected").removeClass(this.widgetBaseClass+"-item-selected"+b).find("a").attr("aria-selected","false").attr("id","");this._selectedOptionLi().addClass(this.widgetBaseClass+"-item-selected"+b).find("a").attr("aria-selected","true").attr("id",c);var d=(this.newelement.data("optionClasses")?this.newelement.data("optionClasses"):"");var e=(this._selectedOptionLi().data("optionClasses")?this._selectedOptionLi().data("optionClasses"):"");this.newelement.removeClass(d).data("optionClasses",e).addClass(e).find("."+this.widgetBaseClass+"-status").html(this._selectedOptionLi().find("a:eq(0)").html());this.list.attr("aria-activedescendant",c)},_refreshPosition:function(){var c=this.options;if(c.style=="popup"&&!c.positionOptions.offset){var d=this._selectedOptionLi();var b="0 "+(this.list.offset().top-d.offset().top-(this.newelement.outerHeight()+d.outerHeight())/2)}this.listWrap.zIndex(this.element.zIndex()+1).position({of:c.positionOptions.of||this.newelement,my:c.positionOptions.my,at:c.positionOptions.at,offset:c.positionOptions.offset||b,collision:c.positionOptions.collision||c.style=="popup"?"fit":"flip"})}})})(jQuery);